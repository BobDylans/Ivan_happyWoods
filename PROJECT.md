# Ivan_HappyWoods - Voice-Based AI Agent Interaction System

> **Project Status**: Phase 3B Testing & Monitoring Complete (æµ‹è¯•ä½“ç³» & Prometheus é›†æˆå®Œæˆ âœ…)
> **Last Updated**: 2025-11-10
> **Version**: 0.4.0-beta
>
> ğŸ“– **æ–°æ‰‹ï¼Ÿ** å…ˆé˜…è¯»æœ¬æ–‡æ¡£çš„"é¡¹ç›®æ¦‚è¿°"å’Œ"å¿«é€Ÿå¯¼èˆª"éƒ¨åˆ†
> â­ **Phase 2 é‡æ„**: Agent Nodes æ¨¡å—åŒ–æ‹†åˆ†å·²å®Œæˆï¼Œè¯¦è§ [`docs/CODE_REFACTORING_PHASE2.md`](docs/CODE_REFACTORING_PHASE2.md)

---

# Copilot Context Refresh

**This file describes the full architecture of Ivan_HappyWoods.**

æœ¬æ–‡æ¡£ä¸º AI Assistant (GitHub Copilot, Cursor, etc.) æä¾›å®Œæ•´çš„é¡¹ç›®ä¸Šä¸‹æ–‡,ç¡®ä¿åœ¨æ–°ç¯å¢ƒä¸­èƒ½å¤Ÿå¿«é€Ÿç†è§£é¡¹ç›®æ¶æ„ã€å½“å‰çŠ¶æ€å’Œå¼€å‘è§„èŒƒã€‚

---

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [å½“å‰æ¶æ„](#å½“å‰æ¶æ„)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [ä»£ç ç»„ç»‡](#ä»£ç ç»„ç»‡)
- [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
- [å·²å®ŒæˆåŠŸèƒ½](#å·²å®ŒæˆåŠŸèƒ½)
- [è¿›è¡Œä¸­åŠŸèƒ½](#è¿›è¡Œä¸­åŠŸèƒ½)
- [å…³é”®æŠ€æœ¯å†³ç­–](#å…³é”®æŠ€æœ¯å†³ç­–)
- [å¼€å‘å·¥ä½œæµ](#å¼€å‘å·¥ä½œæµ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [å¿«é€Ÿå¯¼èˆª](#å¿«é€Ÿå¯¼èˆª)

---

## é¡¹ç›®æ¦‚è¿°

### ğŸ¯ æ ¸å¿ƒç›®æ ‡

Ivan_HappyWoods æ˜¯ä¸€ä¸ª**åŸºäºè¯­éŸ³çš„ AI ä»£ç†äº¤äº’ç³»ç»Ÿ**,æ—¨åœ¨æä¾›:
- ğŸ¤ **è‡ªç„¶è¯­éŸ³äº¤äº’**: æ”¯æŒè¯­éŸ³è¾“å…¥/è¾“å‡ºçš„å¯¹è¯ä½“éªŒ
- ğŸ¤– **æ™ºèƒ½å¯¹è¯ä»£ç†**: åŸºäº LangGraph çš„å¤šæ­¥éª¤æ¨ç†æµç¨‹
- ğŸ”§ **å·¥å…·é›†æˆèƒ½åŠ›**: é€šè¿‡ MCP åè®®é›†æˆå¤–éƒ¨å·¥å…·
- ğŸ“¡ **å®æ—¶æµå¼å“åº”**: SSE å’Œ WebSocket åŒæ¨¡å¼æµå¼ä¼ è¾“
- ğŸŒ **å¤šæ¨¡å‹æ”¯æŒ**: çµæ´»çš„ LLM æ¨¡å‹é€‰æ‹©ç­–ç•¥
- ğŸ’¾ **æŒä¹…åŒ–å­˜å‚¨**: PostgreSQL æ•°æ®åº“å­˜å‚¨ä¼šè¯å’ŒçŠ¶æ€

### ğŸ¨ æ ¸å¿ƒä»·å€¼ä¸»å¼ 

1. **Voice-First Design**: è¯­éŸ³ä½œä¸ºä¸»è¦äº¤äº’æ–¹å¼,æ–‡æœ¬ä½œä¸º fallback
2. **Extensible Architecture**: æ¨¡å—åŒ–è®¾è®¡,æ˜“äºæ‰©å±•æ–°åŠŸèƒ½
3. **Production-Ready**: é¢å‘ç”Ÿäº§ç¯å¢ƒçš„æ¶æ„è®¾è®¡
4. **Developer-Friendly**: å®Œå–„çš„æ–‡æ¡£å’Œå¼€å‘å·¥å…·æ”¯æŒ
5. **Observable by Default**: å…³é”®é“¾è·¯æä¾›ç»“æ„åŒ–æŒ‡æ ‡å’Œæ—¥å¿—,æ–¹ä¾¿æ’éšœä¸æ‰©å®¹

### ğŸ“Š å½“å‰çŠ¶æ€

```
Phase 1 (Core Foundation)        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 2A (Voice Integration)     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 2B (Streaming TTS)         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 2C (Conversation API)      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 2D (Code Optimization)     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 2E (MCP Tools)             â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 2F (AI Features)           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 2 é‡æ„ (Nodesæ¨¡å—åŒ–)        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ… NEW
Phase 3A (PostgreSQL Database)   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 3A.1 (Ollama Integration)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 3A.2 (Config Migration)    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 3B (Test & Monitoring)     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ… NEW
Phase 3C (n8n Integration)       â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% ğŸ“‹
```

**Phase 2 é‡æ„å®Œæˆå†…å®¹** (2025-11-08):
- âœ… Agent Nodes æ¨¡å—åŒ–æ‹†åˆ† (1927è¡Œ â†’ 8ä¸ªä¸“é—¨æ¨¡å—)
- âœ… æç¤ºè¯åˆ†ç¦»åˆ°ç‹¬ç«‹ç›®å½• (`agent/prompts/`)
- âœ… åŸºç¡€è®¾æ–½æŠ½å– (`base.py` - HTTPå®¢æˆ·ç«¯ã€RAGæœåŠ¡)
- âœ… å•ä¸€èŒè´£åŸåˆ™å®ç° (8ä¸ªä¸“é—¨èŠ‚ç‚¹)
- âœ… å‘åå…¼å®¹ä¿æŒ (ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹)
- âœ… èµ„æºç®¡ç†ä¼˜åŒ– (Async Context Manager)
- âœ… ä¿®å¤3ä¸ªå¯¼å…¥é”™è¯¯ (ConfigManager, emojiç¼–ç )
- âœ… æœåŠ¡å™¨å¯åŠ¨æµ‹è¯•é€šè¿‡

**Phase 3A.1 & 3A.2 å®Œæˆå†…å®¹** (2025-11-04):
- âœ… Ollama æœ¬åœ°æ¨¡å‹å®Œå…¨é›†æˆ (æ”¯æŒ qwen, llama, deepseek ç­‰)
- âœ… é…ç½®ç³»ç»Ÿè¿ç§»åˆ°çº¯ .env (ç®€åŒ– 54%, 280è¡Œ â†’ 130è¡Œ)
- âœ… ä¿®å¤ 4 ä¸ªæ–‡ä»¶çš„å‚æ•°ä¸åŒ¹é…é—®é¢˜
- âœ… MCP å·¥å…·é…ç½®å¢å¼º (å¤šæº API Key è¯»å–)
- âœ… è§£å†³ 5 ä¸ªå…³é”®é—®é¢˜ (sqlalchemy, Pydantic, tools.enabled ç­‰)
- âœ… ä»£ç å‡€å‡å°‘ 77 è¡Œ (-4%)

**Phase 3A å®Œæˆå†…å®¹** (2025-10-30 ~ 2025-10-31):
- âœ… PostgreSQL æ•°æ®åº“å®Œå…¨é›†æˆ
- âœ… SQLAlchemy async ORM æ¨¡å‹ (User, Session, Message, ToolCall)
- âœ… PostgreSQLCheckpointer å®ç° LangGraph çŠ¶æ€æŒä¹…åŒ–
- âœ… HybridSessionManager å®ç°å†…å­˜+æ•°æ®åº“æ··åˆå­˜å‚¨ï¼ˆ2025-11 æ›´æ–°ï¼šæ”¹ä¸ºæŒ‰éœ€è·å– AsyncSessionï¼Œå½»åº•æ¶ˆé™¤é™ˆæ—§ä¼šè¯ï¼‰
- âœ… Database repositories CRUD æ“ä½œ
- âœ… models.py å’Œ models_v2.py åˆå¹¶ (-184 è¡Œé‡å¤ä»£ç )
- âœ… mypy ç±»å‹æ£€æŸ¥é…ç½® (ä¿®å¤ 10 ä¸ªåŸºç¡€é”™è¯¯)
- âœ… VS Code Pylance é…ç½®ä¼˜åŒ–

**Phase 3B å®Œæˆå†…å®¹** (2025-11-10):
- âœ… **æµ‹è¯•ä½“ç³»å»ºè®¾**ï¼š
  - Observability æ¨¡å—æµ‹è¯•ï¼ˆ17 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
  - SessionManager å¢å¼ºæµ‹è¯•ï¼ˆ12 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
  - å·¥å…·æŒä¹…åŒ–è§£è€¦æµ‹è¯•ï¼ˆ10 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
  - æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæµ‹è¯•è¦†ç›–ç‡æ˜¾è‘—æå‡
- âœ… **Prometheus ç›‘æ§é›†æˆ**ï¼š
  - PrometheusExporter å®ç°ï¼ˆæ”¯æŒ Counter/Gauge/Histogramï¼‰
  - `/api/v1/metrics` ç«¯ç‚¹è‡ªåŠ¨å¯¼å‡ºæŒ‡æ ‡
  - HTTP/LLM/Agent/Database æŒ‡æ ‡å®Œæ•´è¦†ç›–
  - ä¸ Observability æ— ç¼é›†æˆ
- âœ… **åºŸå¼ƒè­¦å‘Šä¿®å¤**ï¼š
  - ä¿®å¤ `get_config()` åºŸå¼ƒè­¦å‘Šï¼ˆä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼‰
  - ä¿®å¤ `get_tool_registry()` åºŸå¼ƒè­¦å‘Š
  - æ¢å¤ PostgreSQL Checkpointer åŠŸèƒ½
- âœ… RAG æœåŠ¡é›†æˆï¼šæ”¯æŒ Qdrant é›†åˆè‡ªåŠ¨åˆ›å»ºã€æŒ‰ç”¨æˆ·éš”ç¦»ä»¥åŠæç¤ºè¯è‡ªåŠ¨æ³¨å…¥æ£€ç´¢ç‰‡æ®µ
- âœ… RAG é¥æµ‹ï¼šé€šè¿‡ `rag.retrieve_ms`ã€`rag.query_count` ç›‘æ§æ£€ç´¢æ—¶å»¶ä¸å‘½ä¸­çŠ¶æ€
- âœ… å·¥å…·è°ƒç”¨æŒä¹…åŒ–è§£è€¦ï¼šé€šè¿‡ä¾èµ–æ³¨å…¥å°†æŒä¹…åŒ–é€»è¾‘ä¸èŠ‚ç‚¹åˆ†ç¦»ï¼Œæµ‹è¯•/å¤šå®ä¾‹éƒ¨ç½²æ›´æ˜“æ‰©å±•
- âœ… Session ç®¡ç†å¢å¼ºï¼š`HybridSessionManager` é€šè¿‡ `AsyncSession` å·¥å‚æ‡’åŠ è½½æ•°æ®åº“è¿æ¥ï¼Œé¿å…é‡ç”¨å·²å…³é—­ä¼šè¯
- âœ… Observability MVPï¼šHTTP / LLM / å·¥å…· / RAG èŠ‚ç‚¹è¾“å‡ºç»“æ„åŒ–æŒ‡æ ‡æ—¥å¿—ï¼ˆ`METRIC {...}`ï¼‰ï¼Œå·²æ¥å…¥ Prometheus

**Phase 2F å®Œæˆå†…å®¹** (2025-10-17):
- âœ… å·¥å…·è°ƒç”¨åŠŸèƒ½ï¼ˆ7 ä¸ª MCP å·¥å…·ï¼‰
- âœ… æµå¼ + å·¥å…·è°ƒç”¨é›†æˆ
- âœ… ä¸Šä¸‹æ–‡è®°å¿†ï¼ˆå†…å­˜å­˜å‚¨ï¼‰
- âœ… Markdown æ¸²æŸ“ + ä»£ç é«˜äº®
- âœ… æ™ºèƒ½æç¤ºè¯ä¼˜åŒ–
- âœ… Tavily æœç´¢é›†æˆ
- âœ… å®Œæ•´èŠå¤©ç•Œé¢ Demo

---

## å½“å‰æ¶æ„

### ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Client Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  Web Client â”‚  â”‚ Voice Deviceâ”‚  â”‚   API Test  â”‚            â”‚
â”‚  â”‚   (Future)  â”‚  â”‚   (Future)  â”‚  â”‚    Tools    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                 â”‚
          â”‚ HTTP/WS         â”‚ WebSocket       â”‚ REST API
          â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       FastAPI Gateway                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Routes Layer                                            â”‚  â”‚
â”‚  â”‚  â€¢ /api/conversation/* - å¯¹è¯ç®¡ç†                        â”‚  â”‚
â”‚  â”‚  â€¢ /api/voice/*        - è¯­éŸ³å¤„ç†                        â”‚  â”‚
â”‚  â”‚  â€¢ /api/stream/*       - WebSocket æµå¼                  â”‚  â”‚
â”‚  â”‚  â€¢ /health, /metrics   - ç›‘æ§ç«¯ç‚¹                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Middleware Layer                                        â”‚  â”‚
â”‚  â”‚  â€¢ CORS              - è·¨åŸŸæ”¯æŒ                          â”‚  â”‚
â”‚  â”‚  â€¢ Authentication    - API Key éªŒè¯                      â”‚  â”‚
â”‚  â”‚  â€¢ Logging           - è¯·æ±‚/å“åº”æ—¥å¿—                     â”‚  â”‚
â”‚  â”‚  â€¢ Error Handling    - ç»Ÿä¸€é”™è¯¯å¤„ç†                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Service Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   LangGraph  â”‚  â”‚ Conversation â”‚  â”‚    Voice     â”‚         â”‚
â”‚  â”‚     Agent    â”‚  â”‚   Service    â”‚  â”‚   Service    â”‚         â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚         â”‚
â”‚  â”‚  â€¢ Workflow  â”‚  â”‚  â€¢ Sessions  â”‚  â”‚  â€¢ STT (ç§‘å¤§) â”‚         â”‚
â”‚  â”‚  â€¢ Nodes     â”‚  â”‚  â€¢ History   â”‚  â”‚  â€¢ TTS (ç§‘å¤§) â”‚         â”‚
â”‚  â”‚  â€¢ State     â”‚  â”‚  â€¢ Context   â”‚  â”‚  â€¢ Streaming â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                 â”‚                 â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                           â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                   â”‚
          â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   External Services â”‚         â”‚   MCP Tools (Future)    â”‚
â”‚                     â”‚         â”‚                         â”‚
â”‚  â€¢ OpenAI API       â”‚         â”‚  â€¢ Search Tool          â”‚
â”‚  â€¢ iFlytek STT/TTS  â”‚         â”‚  â€¢ Calculator           â”‚
â”‚  â€¢ (Custom Proxy)   â”‚         â”‚  â€¢ Code Executor        â”‚
â”‚                     â”‚         â”‚  â€¢ Image Generator      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ å¯¹è¯æµç¨‹

```
ç”¨æˆ·è¾“å…¥ (æ–‡æœ¬/è¯­éŸ³)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Input Processing  â”‚  è¯­éŸ³ â†’ æ–‡æœ¬è½¬æ¢ (STT)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  æ–‡æœ¬æ¸…æ´—å’ŒéªŒè¯
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Intent Analysis   â”‚  æ„å›¾è¯†åˆ«
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  ä¸Šä¸‹æ–‡æå–
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. LLM Reasoning     â”‚  è°ƒç”¨ LLM API
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  ç”Ÿæˆå“åº”/å·¥å…·è°ƒç”¨
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚           â”‚
    â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4a. Textâ”‚ â”‚ 4b. Toolâ”‚  (Future) å·¥å…·æ‰§è¡Œ
â”‚ Responseâ”‚ â”‚ Calling â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚           â”‚
     â”‚      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
     â”‚      â”‚ Re-queryâ”‚
     â”‚      â”‚   LLM   â”‚
     â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Response Format   â”‚  å“åº”æ ¼å¼åŒ–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  å†å²è®°å½•æ›´æ–°
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Output Generation â”‚  æ–‡æœ¬ â†’ è¯­éŸ³è½¬æ¢ (TTS)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  æµå¼å“åº”æ¨é€
           â”‚
           â–¼
    ç”¨æˆ·æ¥æ”¶å“åº”
```

---

## æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | çŠ¶æ€ |
|------|------|------|------|
| **Python** | 3.11.9 | ä¸»è¦å¼€å‘è¯­è¨€ | âœ… |
| **FastAPI** | 0.120.2 | Web æ¡†æ¶å’Œ API ç½‘å…³ | âœ… |
| **LangGraph** | Latest | å¯¹è¯æµç¨‹ç¼–æ’ | âœ… |
| **Pydantic** | v2 | æ•°æ®éªŒè¯å’Œé…ç½®ç®¡ç† | âœ… |
| **SQLAlchemy** | 2.0+ | å¼‚æ­¥ ORM | âœ… |
| **PostgreSQL** | 14+ | å…³ç³»å‹æ•°æ®åº“ | âœ… |
| **Alembic** | Latest | æ•°æ®åº“è¿ç§» | âœ… |
| **httpx** | Latest | å¼‚æ­¥ HTTP å®¢æˆ·ç«¯ | âœ… |
| **uvicorn** | Latest | ASGI æœåŠ¡å™¨ | âœ… |

### å¤–éƒ¨æœåŠ¡

| æœåŠ¡ | æä¾›å•† | ç”¨é€” | çŠ¶æ€ |
|------|--------|------|------|
| **LLM API** | OpenAI-Compatible | è¯­è¨€æ¨¡å‹æ¨ç† | âœ… |
| **STT** | ç§‘å¤§è®¯é£ (iFlytek) | è¯­éŸ³è¯†åˆ« | âœ… |
| **TTS** | ç§‘å¤§è®¯é£ (iFlytek) | è¯­éŸ³åˆæˆ | âœ… |
| **Search** | Tavily API | ç½‘ç»œæœç´¢å·¥å…· | âœ… |
| **MCP Tools** | Custom | å·¥å…·é›†æˆ (7 tools) | âœ… |

### å¼€å‘å·¥å…·

| å·¥å…· | ç”¨é€” | é…ç½®æ–‡ä»¶ |
|------|------|----------|
| **pytest** | å•å…ƒ/é›†æˆæµ‹è¯• | `pytest.ini` |
| **mypy** | ç±»å‹æ£€æŸ¥ | `mypy.ini` |
| **Pylance** | VS Code ç±»å‹æ£€æŸ¥ | `.vscode/settings.json` |
| **Alembic** | æ•°æ®åº“è¿ç§» | `alembic.ini` |

---

## ä»£ç ç»„ç»‡

### ğŸ“ é¡¹ç›®ç»“æ„

```
Ivan_HappyWoods/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ copilot-instructions.md    # Copilot å¼€å‘æŒ‡å¼• (UPDATED)
â”‚
â”œâ”€â”€ specs/                          # ğŸ“ åŠŸèƒ½è§„æ ¼æ–‡æ¡£
â”‚   â””â”€â”€ 001-voice-interaction-system/
â”‚       â”œâ”€â”€ spec.md                 # åŠŸèƒ½è§„æ ¼
â”‚       â”œâ”€â”€ plan.md                 # å®æ–½è®¡åˆ’
â”‚       â”œâ”€â”€ tasks.md                # ä»»åŠ¡åˆ†è§£
â”‚       â”œâ”€â”€ progress.md             # è¿›åº¦è·Ÿè¸ª (UPDATED)
â”‚       â”œâ”€â”€ architecture.md         # æ¶æ„æ–‡æ¡£
â”‚       â”œâ”€â”€ quickstart.md           # å¿«é€Ÿå¼€å§‹
â”‚       â”œâ”€â”€ data-model.md           # æ•°æ®æ¨¡å‹
â”‚       â””â”€â”€ research.md             # æŠ€æœ¯è°ƒç ”
â”‚
â”œâ”€â”€ docs/                           # ğŸ“š é¡¹ç›®æ–‡æ¡£
â”‚   â”œâ”€â”€ achievements/               # å¼€å‘æˆæœ
â”‚   â”‚   â”œâ”€â”€ INDEX.md               # æˆæœç´¢å¼• (UPDATED)
â”‚   â”‚   â”œâ”€â”€ phase1/                # Phase 1 æˆæœ
â”‚   â”‚   â”œâ”€â”€ phase2/                # Phase 2 æˆæœ
â”‚   â”‚   â”œâ”€â”€ optimizations/         # ä¼˜åŒ–æŠ¥å‘Š
â”‚   â”‚   â””â”€â”€ reports/               # ä¿®å¤æŠ¥å‘Š
â”‚   â”œâ”€â”€ CODE_MERGE_REPORT_2025-10-31.md  # ä»£ç åˆå¹¶æŠ¥å‘Š (NEW)
â”‚   â”œâ”€â”€ CODE_REVIEW_2025-10-31.md        # ä»£ç å®¡æŸ¥æŠ¥å‘Š (NEW)
â”‚   â”œâ”€â”€ VSCODE_TYPE_CHECK_CONFIG.md      # ç±»å‹æ£€æŸ¥é…ç½® (NEW)
â”‚   â”œâ”€â”€ phase2-database-integration-report.md  # æ•°æ®åº“é›†æˆæŠ¥å‘Š
â”‚   â”œâ”€â”€ api/                       # API æ–‡æ¡£ (planned)
â”‚   â”œâ”€â”€ architecture/              # æ¶æ„æ–‡æ¡£ (planned)
â”‚   â””â”€â”€ deployment/                # éƒ¨ç½²æŒ‡å— (planned)
â”‚
â”œâ”€â”€ src/                            # ğŸ’» æºä»£ç 
â”‚   â”œâ”€â”€ agent/                      # ğŸ¤– LangGraph ä»£ç†æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ graph.py               # å·¥ä½œæµå›¾å®šä¹‰ (with PostgreSQL)
â”‚   â”‚   â”œâ”€â”€ nodes/                 # èŠ‚ç‚¹å®ç° (æ¨¡å—åŒ–) â­ NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py        # AgentNodesèšåˆç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ base.py            # åŸºç¡€ç±»å’Œå…±äº«åŠŸèƒ½
â”‚   â”‚   â”‚   â”œâ”€â”€ input_processor.py # è¾“å…¥å¤„ç†èŠ‚ç‚¹
â”‚   â”‚   â”‚   â”œâ”€â”€ message_builder.py # æ¶ˆæ¯æ„å»ºå·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ llm_caller.py      # LLMè°ƒç”¨èŠ‚ç‚¹
â”‚   â”‚   â”‚   â”œâ”€â”€ llm_streamer.py    # æµå¼LLMèŠ‚ç‚¹
â”‚   â”‚   â”‚   â”œâ”€â”€ tool_handler.py    # å·¥å…·æ‰§è¡ŒèŠ‚ç‚¹
â”‚   â”‚   â”‚   â””â”€â”€ response_formatter.py # å“åº”æ ¼å¼åŒ–èŠ‚ç‚¹
â”‚   â”‚   â”œâ”€â”€ prompts/               # æç¤ºè¯æ¨¡æ¿ â­ NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ system_prompts.py  # ç³»ç»Ÿæç¤ºè¯
â”‚   â”‚   â””â”€â”€ state.py               # çŠ¶æ€ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                        # ğŸŒ FastAPI è·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ main.py                # åº”ç”¨å…¥å£ (with database)
â”‚   â”‚   â”œâ”€â”€ conversation_routes.py # å¯¹è¯ç«¯ç‚¹ (async)
â”‚   â”‚   â”œâ”€â”€ voice_routes.py        # è¯­éŸ³ç«¯ç‚¹
â”‚   â”‚   â”œâ”€â”€ mcp_routes.py          # MCP å·¥å…·ç«¯ç‚¹ (NEW)
â”‚   â”‚   â”œâ”€â”€ models.py              # Pydantic æ¨¡å‹ (merged, v2)
â”‚   â”‚   â”œâ”€â”€ middleware.py          # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.py                # è®¤è¯é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ event_utils.py         # äº‹ä»¶å·¥å…·
â”‚   â”‚   â””â”€â”€ stream_manager.py      # æµç®¡ç†å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ database/                   # ğŸ’¾ æ•°æ®åº“å±‚ (NEW)
â”‚   â”‚   â”œâ”€â”€ models.py              # SQLAlchemy ORM æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ checkpointer.py        # PostgreSQLCheckpointer
â”‚   â”‚   â”œâ”€â”€ connection.py          # å¼‚æ­¥æ•°æ®åº“è¿æ¥
â”‚   â”‚   â””â”€â”€ repositories/          # CRUD ä»“å‚¨
â”‚   â”‚       â”œâ”€â”€ conversation_repository.py
â”‚   â”‚       â”œâ”€â”€ session_repository.py
â”‚   â”‚       â”œâ”€â”€ message_repository.py
â”‚   â”‚       â””â”€â”€ tool_call_repository.py
â”‚   â”‚
â”‚   â”œâ”€â”€ mcp/                        # ï¿½ MCP å·¥å…·é›†æˆ
â”‚   â”‚   â”œâ”€â”€ base.py                # å·¥å…·åŸºç±»
â”‚   â”‚   â”œâ”€â”€ tools.py               # åŸºç¡€å·¥å…· (4 tools)
â”‚   â”‚   â”œâ”€â”€ voice_tools.py         # è¯­éŸ³å·¥å…· (3 tools)
â”‚   â”‚   â”œâ”€â”€ registry.py            # å·¥å…·æ³¨å†Œè¡¨
â”‚   â”‚   â””â”€â”€ init_tools.py          # å·¥å…·åˆå§‹åŒ–
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                   # ï¿½ğŸ”§ ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ conversation_service.py # å¯¹è¯æœåŠ¡
â”‚   â”‚   â””â”€â”€ voice/                 # è¯­éŸ³æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ stt_service.py     # STT å®ç°
â”‚   â”‚       â””â”€â”€ tts_service.py     # TTS å®ç°
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                     # âš™ï¸ é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ models.py              # é…ç½®æ¨¡å‹ (with database config)
â”‚   â”‚   â””â”€â”€ settings.py            # é…ç½®åŠ è½½
â”‚   â”‚
â”‚   â””â”€â”€ utils/                      # ğŸ› ï¸ å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ llm_compat.py          # LLM å…¼å®¹å±‚
â”‚       â””â”€â”€ hybrid_session_manager.py  # æ··åˆä¼šè¯ç®¡ç† (NEW)
â”‚
â”œâ”€â”€ tests/                          # ğŸ§ª æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ unit/                      # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ integration/               # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ contract/                  # å¥‘çº¦æµ‹è¯• (planned)
â”‚
â”œâ”€â”€ migrations/                     # ğŸ“‹ æ•°æ®åº“è¿ç§» (Alembic)
â”‚   â”œâ”€â”€ versions/                  # è¿ç§»ç‰ˆæœ¬
â”‚   â”œâ”€â”€ env.py                     # Alembic ç¯å¢ƒ
â”‚   â””â”€â”€ script.py.mako             # è¿ç§»è„šæœ¬æ¨¡æ¿
â”‚
â”œâ”€â”€ scripts/                        # ğŸ”¨ è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ init_db.py                 # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â””â”€â”€ init_db.sql                # SQL åˆå§‹åŒ–è„šæœ¬
â”‚
â”œâ”€â”€ config/                         # ğŸ“‹ é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ development.yaml           # å¼€å‘é…ç½®
â”‚   â”œâ”€â”€ production.yaml            # ç”Ÿäº§é…ç½®
â”‚   â””â”€â”€ testing.yaml               # æµ‹è¯•é…ç½®
â”‚
â”œâ”€â”€ .vscode/                        # ğŸ”§ VS Code é…ç½® (NEW)
â”‚   â””â”€â”€ settings.json              # Pylance ç±»å‹æ£€æŸ¥é…ç½®
â”‚
â”œâ”€â”€ logs/                           # ğŸ“ æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ test_audio/                     # ğŸµ æµ‹è¯•éŸ³é¢‘
â”‚
â”œâ”€â”€ .env                            # ğŸ” ç¯å¢ƒå˜é‡ (ä¸æäº¤)
â”œâ”€â”€ .env.example                    # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ requirements.txt                # Python ä¾èµ– (updated)
â”œâ”€â”€ pytest.ini                      # pytest é…ç½®
â”œâ”€â”€ mypy.ini                        # mypy é…ç½® (NEW)
â”œâ”€â”€ alembic.ini                     # Alembic é…ç½®
â”œâ”€â”€ start_server.py                 # æœåŠ¡å¯åŠ¨è„šæœ¬
â”œâ”€â”€ test_conversation.py            # å¯¹è¯æµ‹è¯•è„šæœ¬
â”‚
â”œâ”€â”€ PROJECT.md                      # æœ¬æ–‡ä»¶ - é¡¹ç›®æ€»è§ˆ (UPDATED)
â”œâ”€â”€ CHANGELOG.md                    # å˜æ›´æ—¥å¿— (TO UPDATE)
â””â”€â”€ README.md                       # é¡¹ç›®è¯´æ˜ (planned)
```

### ğŸ¯ å…³é”®æ¨¡å—è¯´æ˜

#### 1. Agent æ¨¡å— (`src/agent/`)

**èŒè´£**: LangGraph å·¥ä½œæµæ ¸å¿ƒ

- **`graph.py`** (375 è¡Œ)
  - `VoiceAgent` ç±»: ä¸»å¯¹è¯ä»£ç†
  - `_build_graph()`: æ„å»º LangGraph å·¥ä½œæµ
  - `process_message()`: åŒæ­¥æ¶ˆæ¯å¤„ç†
  - `process_message_stream()`: æµå¼æ¶ˆæ¯å¤„ç†
  - è·¯ç”±å‡½æ•°: `_route_after_input/llm/tools()`

- **`nodes/`** (æ¨¡å—åŒ–åŒ…) - â­ **Phase 2 é‡æ„å®Œæˆ**

  **`__init__.py`** (467 è¡Œ) - AgentNodes èšåˆç±»
  - å‘åå…¼å®¹æ¥å£ï¼Œå§”æ‰˜ç»™ä¸“é—¨æ¨¡å—
  - èµ„æºç®¡ç† (async context manager)

  **`base.py`** (390+ è¡Œ) - åŸºç¡€è®¾æ–½
  - HTTP å®¢æˆ·ç«¯æ‡’åŠ è½½ (çº¿ç¨‹å®‰å…¨)
  - RAG æœåŠ¡é›†æˆ
  - å·¥å…·æ‰§è¡ŒåŸºç¡€æ–¹æ³•
  - èµ„æºæ¸…ç†

  **`input_processor.py`** (220+ è¡Œ) - è¾“å…¥å¤„ç†
  - è¾“å…¥éªŒè¯å’Œæ¸…æ´—
  - æ„å›¾åˆ†æ
  - ç”¨æˆ·æ¶ˆæ¯åˆ›å»º

  **`message_builder.py`** (430+ è¡Œ) - æ¶ˆæ¯æ„å»º
  - LLM æ¶ˆæ¯å‡†å¤‡
  - å†å²æ¶ˆæ¯ç®¡ç†
  - ç³»ç»Ÿæç¤ºè¯æ³¨å…¥

  **`llm_caller.py`** (670+ è¡Œ) - LLM è°ƒç”¨
  - éæµå¼ API è°ƒç”¨
  - å·¥å…·è°ƒç”¨æ£€æµ‹
  - æ™ºèƒ½é™çº§ç­–ç•¥

  **`llm_streamer.py`** (780+ è¡Œ) - æµå¼ LLM
  - SSE æµå¼å“åº”
  - å·¥å…·è°ƒç”¨ç´¯ç§¯
  - å¤šè½®å·¥å…·æ‰§è¡Œ

  **`tool_handler.py`** (560+ è¡Œ) - å·¥å…·æ‰§è¡Œ
  - MCP å·¥å…·è°ƒç”¨
  - æ•°æ®åº“æŒä¹…åŒ–
  - é”™è¯¯å¤„ç†

  **`response_formatter.py`** (250+ è¡Œ) - å“åº”æ ¼å¼åŒ–
  - æœ€ç»ˆå“åº”ç”Ÿæˆ
  - å†å²è®°å½•æ›´æ–°

- **`prompts/`** - æç¤ºè¯æ¨¡æ¿
  - `system_prompts.py` (850+ è¡Œ)
  - `BASE_IDENTITY`: æ ¸å¿ƒè§’è‰²å®šä¹‰
  - `TASK_FRAMEWORK`: ä»»åŠ¡å¤„ç†æ¡†æ¶
  - `build_optimized_system_prompt()`: åŠ¨æ€æç¤ºè¯æ„å»º

- **`state.py`**
  - `AgentState`: å¯¹è¯çŠ¶æ€æ¨¡å‹
  - `create_initial_state()`: åˆå§‹çŠ¶æ€åˆ›å»º

**é‡æ„äº®ç‚¹**:
- å•ä¸€èŒè´£åŸåˆ™ - æ¯ä¸ªæ¨¡å—ä¸€ä¸ªæ˜ç¡®ä»»åŠ¡
- ä¾èµ–æ³¨å…¥ - æ‰€æœ‰æ¨¡å—ç»§æ‰¿ `AgentNodesBase`
- å‘åå…¼å®¹ - ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
- è¯¦è§ [`docs/CODE_REFACTORING_PHASE2.md`](docs/CODE_REFACTORING_PHASE2.md)

#### 2. API æ¨¡å— (`src/api/`)

**èŒè´£**: FastAPI è·¯ç”±å’Œä¸­é—´ä»¶

- **`main.py`**: FastAPI åº”ç”¨å…¥å£
- **`conversation_routes.py`**: å¯¹è¯ API ç«¯ç‚¹
  - `POST /api/conversation/send` - å‘é€æ¶ˆæ¯
  - `GET /api/conversation/history` - è·å–å†å²
  - `GET /api/conversation/stream` - SSE æµå¼
  - `WebSocket /api/conversation/ws` - WebSocket æµå¼

- **`voice_routes.py`**: è¯­éŸ³ API ç«¯ç‚¹
  - `POST /api/voice/stt` - è¯­éŸ³è¯†åˆ«
  - `POST /api/voice/tts` - è¯­éŸ³åˆæˆ
  - `WebSocket /api/voice/stream` - æµå¼è¯­éŸ³

- **`middleware.py`**: 
  - CORS ä¸­é—´ä»¶
  - æ—¥å¿—ä¸­é—´ä»¶
  - é”™è¯¯å¤„ç†ä¸­é—´ä»¶

- **`auth.py`**: API Key è®¤è¯

#### 3. Services æ¨¡å— (`src/services/`)

**èŒè´£**: ä¸šåŠ¡é€»è¾‘å±‚

- **`conversation_service.py`**
  - ä¼šè¯ç®¡ç†
  - å†å²è®°å½•
  - ä¸Šä¸‹æ–‡ç»´æŠ¤

- **`voice/stt_service.py`** (ç§‘å¤§è®¯é£ STT)
  - WebSocket è¿æ¥ç®¡ç†
  - éŸ³é¢‘æµå¤„ç†
  - å®æ—¶è½¬å†™

- **`voice/tts_service.py`** (ç§‘å¤§è®¯é£ TTS)
  - æ–‡æœ¬åˆæˆ
  - æµå¼éŸ³é¢‘ç”Ÿæˆ
  - éŸ³é¢‘æ ¼å¼è½¬æ¢

#### 4. Config æ¨¡å— (`src/config/`)

**èŒè´£**: é…ç½®ç®¡ç†

- **`models.py`**: Pydantic é…ç½®æ¨¡å‹
  - `VoiceAgentConfig`: ä¸»é…ç½®
  - `LLMConfig`: LLM é…ç½®
  - `SpeechConfig`: è¯­éŸ³é…ç½®
  - `APIConfig`: API é…ç½®

- **`settings.py`**: é…ç½®åŠ è½½å™¨
  - ç¯å¢ƒå˜é‡åŠ è½½
  - é…ç½®éªŒè¯
  - é…ç½®åˆå¹¶

#### 5. Utils æ¨¡å— (`src/utils/`)

**èŒè´£**: å·¥å…·å‡½æ•°

- **`llm_compat.py`**: LLM å…¼å®¹å±‚
  - `prepare_llm_params()`: å‚æ•°å‡†å¤‡
  - æ¨¡å‹ç‰¹æ€§æ£€æµ‹
  - GPT-5 ç³»åˆ—ç‰¹æ®Šå¤„ç†

---

## ç¯å¢ƒé…ç½®

### ğŸ”§ å¿…éœ€çš„ç¯å¢ƒå˜é‡

#### 1. LLM é…ç½® (å¿…éœ€)

```bash
# OpenAI-Compatible API
VOICE_AGENT_LLM__API_KEY=your_api_key_here
VOICE_AGENT_LLM__BASE_URL=https://api.openai-proxy.org/v1
VOICE_AGENT_LLM__PROVIDER=openai

# æ¨¡å‹é€‰æ‹©
VOICE_AGENT_LLM__MODELS__DEFAULT=gpt-5-mini                 # é»˜è®¤æ¨¡å‹
VOICE_AGENT_LLM__MODELS__FAST=gpt-5-nano                    # å¿«é€Ÿæ¨¡å‹
VOICE_AGENT_LLM__MODELS__CREATIVE=gpt-5-chat-latest         # åˆ›æ„æ¨¡å‹

# LLM å‚æ•°
VOICE_AGENT_LLM__TIMEOUT=30
VOICE_AGENT_LLM__MAX_TOKENS=2048
VOICE_AGENT_LLM__TEMPERATURE=0.7
```

#### 2. è¯­éŸ³æœåŠ¡é…ç½® (å¿…éœ€)

```bash
# ç§‘å¤§è®¯é£å‡­è¯ - åœ¨ https://www.xfyun.cn/ æ³¨å†Œ
IFLYTEK_APPID=your_appid
IFLYTEK_APIKEY=your_apikey
IFLYTEK_APISECRET=your_apisecret

# TTS é…ç½®
IFLYTEK_TTS_APPID=your_appid
IFLYTEK_TTS_APIKEY=your_apikey
IFLYTEK_TTS_APISECRET=your_apisecret

# è¯­éŸ³åå¥½
VOICE_AGENT_SPEECH__TTS__PROVIDER=iflytek
VOICE_AGENT_SPEECH__TTS__VOICE=x4_lingxiaoxuan_oral
VOICE_AGENT_SPEECH__TTS__SPEED=50
VOICE_AGENT_SPEECH__TTS__FORMAT=mp3
```

#### 3. API æœåŠ¡é…ç½® (å¯é€‰)

```bash
# æœåŠ¡å™¨é…ç½®
VOICE_AGENT_API__HOST=0.0.0.0
VOICE_AGENT_API__PORT=8000
VOICE_AGENT_API__RELOAD=true

# è®¤è¯
API_KEY_ENABLED=true
API_KEYS=dev-test-key-123

# CORS
VOICE_AGENT_SECURITY__CORS_ORIGINS=http://localhost:3000
```

#### 4. ä¼šè¯ç®¡ç† (å¯é€‰)

```bash
# å†…å­˜å­˜å‚¨ (å¼€å‘)
VOICE_AGENT_SESSION__STORAGE_TYPE=memory
VOICE_AGENT_SESSION__TIMEOUT_MINUTES=30
VOICE_AGENT_SESSION__MAX_HISTORY=50

# Redis å­˜å‚¨ (ç”Ÿäº§ - Future)
# VOICE_AGENT_SESSION__STORAGE_TYPE=redis
# VOICE_AGENT_SESSION__REDIS_URL=redis://localhost:6379/0
```

### ğŸ“¦ ä¾èµ–å®‰è£…

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository-url>
cd Ivan_happyWoods

# 2. è¿›å…¥è™šæ‹Ÿç¯å¢ƒ â­ é‡è¦
# è™šæ‹Ÿç¯å¢ƒ (venv/) ä¸­å·²é¢„è£…æ‰€æœ‰ä¾èµ–
# Windows:
venv\Scripts\activate

# Linux/macOS:
source venv/bin/activate

# 3. å®‰è£…ä¾èµ–ï¼ˆå¦‚éœ€æ›´æ–°ï¼‰
pip install -r requirements.txt

# 4. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶,å¡«å…¥å®é™…å‡­è¯

# 5. éªŒè¯å®‰è£…
python -c "import fastapi; import langgraph; print('OK')"
```

### ğŸš€ å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼ (è‡ªåŠ¨é‡è½½)
python start_server.py

# æˆ–ä½¿ç”¨ uvicorn
uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000

# ç”Ÿäº§æ¨¡å¼
uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --workers 4
```

### âœ… éªŒè¯è¿è¡Œ

```bash
# 1. å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# 2. API æ–‡æ¡£
# æµè§ˆå™¨è®¿é—®: http://localhost:8000/docs

# 3. æµ‹è¯•å¯¹è¯
python test_conversation.py
```

---

## å·²å®ŒæˆåŠŸèƒ½

### âœ… Phase 1: æ ¸å¿ƒåŸºç¡€ (2025-10-13 ~ 2025-10-14)

- [x] FastAPI åº”ç”¨æ¡†æ¶æ­å»º
- [x] LangGraph å¯¹è¯æµç¨‹å®ç°
- [x] OpenAI-Compatible LLM é›†æˆ
- [x] ä¼šè¯ç®¡ç† (å†…å­˜å­˜å‚¨)
- [x] æ–‡æœ¬å¯¹è¯ MVP
- [x] SSE æµå¼å“åº” (POST/GET)
- [x] WebSocket æµå¼å“åº”
- [x] æ¨¡å‹é€‰æ‹©ç­–ç•¥ (default/fast/creative)
- [x] åŸºç¡€å¥åº·ç›‘æ§ç«¯ç‚¹

**å…³é”®æ–‡ä»¶**: 
- `src/agent/graph.py`
- `src/agent/nodes.py`
- `src/api/main.py`
- `src/api/conversation_routes.py`

### âœ… Phase 2A: è¯­éŸ³é›†æˆ (2025-10-14)

- [x] ç§‘å¤§è®¯é£ STT é›†æˆ
- [x] ç§‘å¤§è®¯é£ TTS é›†æˆ
- [x] WebSocket è¯­éŸ³æµå¤„ç†
- [x] éŸ³é¢‘æ ¼å¼è½¬æ¢
- [x] å®æ—¶è¯­éŸ³è½¬å†™

**å…³é”®æ–‡ä»¶**:
- `src/services/voice/stt_service.py`
- `src/services/voice/tts_service.py`
- `src/api/voice_routes.py`

**æ–‡æ¡£**:
- [TTS_QUICKSTART.md](./docs/achievements/phase2/TTS_QUICKSTART.md)
- [TTS_STREAM_GUIDE.md](./docs/achievements/phase2/TTS_STREAM_GUIDE.md)

### âœ… Phase 2B: æµå¼ TTS (2025-10-14)

- [x] TTS æµå¼éŸ³é¢‘ç”Ÿæˆ
- [x] WebSocket å®æ—¶æ¨é€
- [x] éŸ³é¢‘åˆ†ç‰‡ä¼ è¾“
- [x] å»¶è¿Ÿä¼˜åŒ– (<500ms é¦–å­—èŠ‚)

**æ–‡æ¡£**:
- [TTS_FIXED_REPORT.md](./docs/achievements/phase2/TTS_FIXED_REPORT.md)

### âœ… Phase 2C: å¯¹è¯ API å®Œå–„ (2025-10-14)

- [x] å¯¹è¯å†å²æŸ¥è¯¢ API
- [x] ä¼šè¯æ¸…é™¤ API
- [x] æµå¼å¯¹è¯å†å²æŒä¹…åŒ–
- [x] é”™è¯¯å¤„ç†ä¼˜åŒ–
- [x] API è®¤è¯ (API Key)

**æ–‡æ¡£**:
- [CONVERSATION_IMPLEMENTATION_REPORT.md](./docs/achievements/phase2/CONVERSATION_IMPLEMENTATION_REPORT.md)
- [CONVERSATION_API_GUIDE.md](./docs/achievements/phase2/CONVERSATION_API_GUIDE.md)
- [CONVERSATION_BUG_FIX.md](./docs/achievements/phase2/CONVERSATION_BUG_FIX.md)

### âœ… Phase 2D: ä»£ç è´¨é‡ä¼˜åŒ– (2025-10-15)

- [x] ä»£ç å»é‡ (Extract Method æ¨¡å¼)
- [x] èµ„æºç®¡ç†ä¼˜åŒ–
- [x] ä¸­æ–‡æœ¬åœ°åŒ–
- [x] LLM å…¼å®¹æ€§ä¿®å¤

**æ–‡æ¡£**:
- [CODE_OPTIMIZATION_COMPLETE.md](./docs/achievements/optimizations/CODE_OPTIMIZATION_COMPLETE.md) â­

### âœ… Phase 2E: MCP å·¥å…·é›†æˆ (2025-10-16)

- [x] MCP åè®®å®ç°
- [x] å·¥å…·æ³¨å†Œå’Œå‘ç°æœºåˆ¶
- [x] åŸºç¡€å·¥å…·é›†:
  - [x] Web æœç´¢å·¥å…· (Tavily API)
  - [x] è®¡ç®—å™¨
  - [x] æ—¶é—´/æ—¥æœŸå·¥å…·
  - [x] å¤©æ°”æŸ¥è¯¢å·¥å…·
  - [x] è¯­éŸ³åˆæˆ/è¯†åˆ«å·¥å…·
- [x] å·¥å…·è°ƒç”¨æµç¨‹é›†æˆ
- [x] é”™è¯¯å¤„ç†å’Œé™çº§

**å…³é”®æ–‡ä»¶**:
- `src/mcp/base.py` - MCP å·¥å…·åŸºç±»
- `src/mcp/tools.py` - 7 ä¸ªå·¥å…·å®ç°
- `src/mcp/registry.py` - å·¥å…·æ³¨å†Œè¡¨

### âœ… Phase 2F: AI åŠŸèƒ½å®Œå–„ (2025-10-17)

- [x] **å·¥å…·è°ƒç”¨å®Œæ•´å®ç°**
  - OpenAI Function Calling æ ¼å¼æ”¯æŒ
  - æµå¼ + éæµå¼å·¥å…·è°ƒç”¨
  - å·¥å…·ç»“æœæ™ºèƒ½æ•´åˆ
  
- [x] **ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½**
  - å†…å­˜ä¼šè¯å†å²ç®¡ç†
  - æœ€å¤šä¿ç•™ 20 æ¡æ¶ˆæ¯
  - 24 å°æ—¶ TTL è‡ªåŠ¨æ¸…ç†
  
- [x] **æµå¼å“åº”ä¼˜åŒ–**
  - SSE å®æ—¶æ¨é€
  - å·¥å…·è°ƒç”¨çŠ¶æ€æ˜¾ç¤º
  - æ‰“å­—æœºæ•ˆæœ
  
- [x] **Markdown æ¸²æŸ“**
  - AI å›å¤æ ¼å¼åŒ–
  - ä»£ç è¯­æ³•é«˜äº®
  - é“¾æ¥ã€åˆ—è¡¨ç¾åŒ–
  
- [x] **æç¤ºè¯ä¼˜åŒ–**
  - æ™ºèƒ½ Markdown æ ¼å¼æŒ‡å¼•
  - ä¿¡æ¯æ¥æºæ ‡æ³¨è§„èŒƒ
  - ç»“æ„åŒ–è¾“å‡ºæ¨¡æ¿

**å…³é”®å®ç°**:
- `src/utils/session_manager.py` - ä¼šè¯å†å²ç®¡ç†
- `src/agent/nodes.py` - å·¥å…·è°ƒç”¨ + æµå¼å¤„ç†
- `demo/chat_demo.html` - å®Œæ•´èŠå¤©ç•Œé¢

**æµ‹è¯•éªŒè¯**:
```bash
# å¯åŠ¨æœåŠ¡
python start_server.py

# è®¿é—®èŠå¤©ç•Œé¢
# æµè§ˆå™¨æ‰“å¼€: demo/chat_demo.html

# æµ‹è¯•å‘½ä»¤
"æœç´¢ç‰¹æœ—æ™®æœ€æ–°æ–°é—»"  # æµ‹è¯•å·¥å…·è°ƒç”¨
"æˆ‘å«å°æ˜"            # æµ‹è¯•ä¸Šä¸‹æ–‡è®°å¿†
"æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"      # éªŒè¯è®°å¿†åŠŸèƒ½
```

---

## è¿›è¡Œä¸­åŠŸèƒ½

### â³ Phase 3A: æ•°æ®åº“æŒä¹…åŒ– (è§„åˆ’ä¸­)

**è®¡åˆ’åŠŸèƒ½**:
- [ ] PostgreSQL é›†æˆ
- [ ] ä¼šè¯æŒä¹…åŒ–å­˜å‚¨
- [ ] å·¥å…·è°ƒç”¨è®°å½•
- [ ] ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ

---

## å…³é”®æŠ€æœ¯å†³ç­–

### 1. ä¸ºä»€ä¹ˆé€‰æ‹© LangGraph?

**å†³ç­–**: ä½¿ç”¨ LangGraph è€Œéç®€å•çš„ LLM Chain

**åŸå› **:
- âœ… **çŠ¶æ€ç®¡ç†**: å†…ç½®ä¼šè¯çŠ¶æ€ç®¡ç†
- âœ… **æµç¨‹æ§åˆ¶**: æ¸…æ™°çš„èŠ‚ç‚¹å’Œè¾¹å®šä¹‰
- âœ… **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°èŠ‚ç‚¹(å¦‚å·¥å…·è°ƒç”¨)
- âœ… **è°ƒè¯•èƒ½åŠ›**: å¯è§†åŒ–å·¥ä½œæµ,æ–¹ä¾¿è°ƒè¯•
- âœ… **æ£€æŸ¥ç‚¹**: æ”¯æŒä¼šè¯æŒä¹…åŒ–

**æƒè¡¡**: å¢åŠ äº†å­¦ä¹ æ›²çº¿,ä½†é•¿æœŸæ”¶ç›Šæ˜æ˜¾

### 2. ä¸ºä»€ä¹ˆä½¿ç”¨ç§‘å¤§è®¯é£ STT/TTS?

**å†³ç­–**: é€‰æ‹©ç§‘å¤§è®¯é£è€Œé OpenAI Whisper/TTS

**åŸå› **:
- âœ… **ä¸­æ–‡ä¼˜åŒ–**: å¯¹ä¸­æ–‡è¯­éŸ³è¯†åˆ«æ•ˆæœæ›´å¥½
- âœ… **æµå¼æ”¯æŒ**: åŸç”Ÿ WebSocket æµå¼æ¥å£
- âœ… **å»¶è¿Ÿä½**: <500ms é¦–å­—èŠ‚å»¶è¿Ÿ
- âœ… **æˆæœ¬**: ç›¸å¯¹ OpenAI æ›´ç»æµ
- âœ… **æœ¬åœ°åŒ–**: å›½å†…è®¿é—®ç¨³å®š

**æƒè¡¡**: API æ–‡æ¡£ç›¸å¯¹è¾ƒå°‘,éœ€è¦æ›´å¤šé›†æˆå·¥ä½œ

### 3. ä¸ºä»€ä¹ˆé‡‡ç”¨å†…å­˜ä¼šè¯å­˜å‚¨?

**å†³ç­–**: Phase 1-2 ä½¿ç”¨ LangGraph MemorySaver (å†…å­˜)

**åŸå› **:
- âœ… **ç®€å•**: æ— éœ€é¢å¤–ä¾èµ–å’Œé…ç½®
- âœ… **å¿«é€Ÿ**: å¼€å‘è¿­ä»£é€Ÿåº¦å¿«
- âœ… **é€‚åˆ MVP**: éªŒè¯æ ¸å¿ƒåŠŸèƒ½

**é™åˆ¶**:
- âš ï¸ æœåŠ¡é‡å¯ä¸¢å¤±æ•°æ®
- âš ï¸ æ— æ³•æ¨ªå‘æ‰©å±•
- âš ï¸ ä»…é€‚åˆå¼€å‘/æµ‹è¯•

**æœªæ¥è®¡åˆ’**: Phase 3 è¿ç§»åˆ° Redis

### 4. ä¸ºä»€ä¹ˆä»£ç å…¨ä¸­æ–‡åŒ–?

**å†³ç­–**: Phase 2D å°†æ³¨é‡Šã€é”™è¯¯æ¶ˆæ¯å…¨éƒ¨ä¸­æ–‡åŒ–

**åŸå› **:
- âœ… **ç”¨æˆ·ä½“éªŒ**: ä¸­æ–‡ç”¨æˆ·æ›´å‹å¥½
- âœ… **å¼€å‘æ•ˆç‡**: å›¢é˜Ÿä¸»è¦ä½¿ç”¨ä¸­æ–‡
- âœ… **ç»´æŠ¤æ€§**: é™ä½ç†è§£æˆæœ¬

**å®æ–½**:
- æ–‡æ¡£å­—ç¬¦ä¸²: ä¸­æ–‡
- ç”¨æˆ·é”™è¯¯æ¶ˆæ¯: ä¸­æ–‡
- æ—¥å¿—æ¶ˆæ¯: ä¸­æ–‡
- å˜é‡/å‡½æ•°å: ä¿æŒè‹±æ–‡ (ä»£ç è§„èŒƒ)

### 5. ä¸ºä»€ä¹ˆæå–è¾…åŠ©æ–¹æ³•?

**å†³ç­–**: Extract Method é‡æ„æ¨¡å¼

**åŸå› **:
- âœ… **DRY åŸåˆ™**: æ¶ˆé™¤é‡å¤ä»£ç 
- âœ… **å¯æµ‹è¯•æ€§**: ç‹¬ç«‹æ–¹æ³•æ˜“äºæµ‹è¯•
- âœ… **å¯ç»´æŠ¤æ€§**: å•ä¸€èŒè´£åŸåˆ™

**ç¤ºä¾‹**:
```python
# Before: é‡å¤ 50 è¡Œ
if self._http_client is None:
    async with self._client_lock:
        # ... 25 è¡Œåˆå§‹åŒ–ä»£ç 

# After: å•ä¸€æ–¹æ³•
await self._ensure_http_client()  # å¤ç”¨
```

---

## å¼€å‘å·¥ä½œæµ

### ğŸ”„ æ ‡å‡†å¼€å‘æµç¨‹

```bash
# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/new-feature

# 2. æ›´æ–°ä¾èµ– (å¦‚éœ€è¦)
pip install -r requirements.txt

# 3. ä¿®æ”¹ä»£ç 
# ... ç¼–ç  ...

# 4. è¿è¡Œæµ‹è¯•
pytest tests/

# 5. ä»£ç æ£€æŸ¥
ruff check src/

# 6. æœ¬åœ°éªŒè¯
python start_server.py
python test_conversation.py

# 7. æäº¤ä»£ç 
git add .
git commit -m "feat: æ·»åŠ æ–°åŠŸèƒ½"

# 8. åˆå¹¶åˆ°ä¸»åˆ†æ”¯
git push origin feature/new-feature
```

### ğŸ§ª æµ‹è¯•ç­–ç•¥

```bash
# å•å…ƒæµ‹è¯•
pytest tests/unit/ -v

# é›†æˆæµ‹è¯•
pytest tests/integration/ -v

# æµ‹è¯•è¦†ç›–ç‡
pytest --cov=src tests/

# ç‰¹å®šæ¨¡å—æµ‹è¯•
pytest tests/unit/test_agent.py -v

# è·³è¿‡æ…¢æµ‹è¯•
pytest -m "not slow"
```

### ğŸ“ æäº¤è§„èŒƒ

éµå¾ª Conventional Commits:

```
feat: æ–°åŠŸèƒ½
fix: Bug ä¿®å¤
docs: æ–‡æ¡£æ›´æ–°
style: ä»£ç æ ¼å¼
refactor: é‡æ„
test: æµ‹è¯•ç›¸å…³
chore: æ„å»º/å·¥å…·
```

ç¤ºä¾‹:
```bash
git commit -m "feat(agent): æ·»åŠ å·¥å…·è°ƒç”¨æ”¯æŒ"
git commit -m "fix(tts): ä¿®å¤æµå¼éŸ³é¢‘æ–­æµé—®é¢˜"
git commit -m "docs: æ›´æ–° API ä½¿ç”¨æŒ‡å—"
```

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ·»åŠ æ–°çš„ LangGraph èŠ‚ç‚¹?

**æ­¥éª¤**:
1. åœ¨ `src/agent/nodes.py` çš„ `AgentNodes` ç±»ä¸­æ·»åŠ æ–°æ–¹æ³•
2. æ–¹æ³•ç­¾å: `async def my_node(self, state: AgentState) -> AgentState`
3. åœ¨ `src/agent/graph.py` çš„ `_build_graph()` ä¸­æ³¨å†Œ: `workflow.add_node("my_node", self.nodes.my_node)`
4. æ·»åŠ è·¯ç”±é€»è¾‘
5. æ›´æ–° `state.py` (å¦‚éœ€æ–°çŠ¶æ€å­—æ®µ)

**ç¤ºä¾‹**:
```python
# nodes.py
async def my_tool_node(self, state: AgentState) -> AgentState:
    """æ‰§è¡Œå¤–éƒ¨å·¥å…·è°ƒç”¨"""
    tool_name = state.get("tool_to_call")
    result = await self._execute_tool(tool_name)
    state["tool_result"] = result
    state["next_action"] = "format_response"
    return state

# graph.py
workflow.add_node("my_tool", self.nodes.my_tool_node)
workflow.add_edge("call_llm", "my_tool")
```

### Q2: å¦‚ä½•æ·»åŠ æ–°çš„ API ç«¯ç‚¹?

**æ­¥éª¤**:
1. åœ¨ `src/api/` åˆ›å»ºæˆ–ç¼–è¾‘è·¯ç”±æ–‡ä»¶ (å¦‚ `my_routes.py`)
2. å®šä¹‰ Pydantic æ¨¡å‹ (åœ¨ `models.py`)
3. å®ç°è·¯ç”±å‡½æ•°
4. åœ¨ `src/api/main.py` æ³¨å†Œè·¯ç”±

**ç¤ºä¾‹**:
```python
# models.py
class MyRequest(BaseModel):
    param: str

class MyResponse(BaseModel):
    result: str

# my_routes.py
from fastapi import APIRouter
router = APIRouter(prefix="/api/my")

@router.post("/endpoint", response_model=MyResponse)
async def my_endpoint(request: MyRequest):
    return MyResponse(result=f"Processed: {request.param}")

# main.py
from api.my_routes import router as my_router
app.include_router(my_router)
```

### Q3: å¦‚ä½•è°ƒè¯• LangGraph å·¥ä½œæµ?

**æ–¹æ³•**:
1. **æ—¥å¿—è°ƒè¯•**:
   ```python
   self.logger.debug(f"State after node: {state}")
   ```

2. **æ–­ç‚¹è°ƒè¯•**:
   ```python
   import pdb; pdb.set_trace()  # åœ¨èŠ‚ç‚¹ä¸­è®¾ç½®æ–­ç‚¹
   ```

3. **çŠ¶æ€æ£€æŸ¥**:
   ```python
   # åœ¨èŠ‚ç‚¹æœ«å°¾æ‰“å°çŠ¶æ€
   print(f"Next action: {state.get('next_action')}")
   print(f"Messages: {len(state['messages'])}")
   ```

4. **ä½¿ç”¨ LangGraph å†…ç½®å·¥å…·** (Future):
   ```python
   # å¯è§†åŒ–å·¥ä½œæµ
   graph.get_graph().print_ascii()
   ```

### Q4: å¦‚ä½•åˆ‡æ¢ LLM æ¨¡å‹?

**æ–¹æ³• 1: ç¯å¢ƒå˜é‡**
```bash
# .env
VOICE_AGENT_LLM__MODELS__DEFAULT=gpt-4
```

**æ–¹æ³• 2: API è¯·æ±‚**
```python
# è¯·æ±‚ä¸­æŒ‡å®šæ¨¡å‹
response = await client.post("/api/conversation/send", json={
    "session_id": "test",
    "message": "Hello",
    "model_config": {
        "model": "gpt-3.5-turbo"  # è¦†ç›–é»˜è®¤æ¨¡å‹
    }
})
```

**æ–¹æ³• 3: ä»£ç ä¸­ä¿®æ”¹**
```python
# src/config/models.py
class LLMModels(BaseModel):
    default: str = "gpt-4"  # ä¿®æ”¹é»˜è®¤æ¨¡å‹
```

### Q5: å¦‚ä½•æ·»åŠ æ–°çš„è¯­éŸ³æä¾›å•†?

**æ­¥éª¤**:
1. åœ¨ `src/services/voice/` åˆ›å»ºæ–°æ–‡ä»¶ (å¦‚ `aws_tts_service.py`)
2. å®ç°ç»Ÿä¸€æ¥å£:
   ```python
   class AWSTTSService:
       async def synthesize(self, text: str) -> bytes:
           pass
       async def synthesize_stream(self, text: str):
           async for chunk in ...:
               yield chunk
   ```
3. åœ¨é…ç½®ä¸­æ·»åŠ æä¾›å•†:
   ```python
   # config/models.py
   class TTSConfig(BaseModel):
       provider: Literal["iflytek", "aws", "azure"] = "iflytek"
   ```
4. åœ¨è·¯ç”±ä¸­æ·»åŠ åˆ†å‘é€»è¾‘:
   ```python
   # voice_routes.py
   if config.tts.provider == "aws":
       service = AWSTTSService()
   ```

### Q6: å¦‚ä½•ä¼˜åŒ–æµå¼å“åº”å»¶è¿Ÿ?

**æŠ€å·§**:
1. **å‡å°‘é¦–å­—èŠ‚æ—¶é—´ (TTFB)**:
   - ä½¿ç”¨æµå¼ LLM è°ƒç”¨
   - å°½æ—©å‘é€ `start` äº‹ä»¶
   
2. **ä¼˜åŒ–åˆ†ç‰‡å¤§å°**:
   ```python
   # è°ƒæ•´ TTS éŸ³é¢‘åˆ†ç‰‡
   CHUNK_SIZE = 1024  # æ›´å° = æ›´ä½å»¶è¿Ÿ,ä½†æ›´å¤šå¼€é”€
   ```

3. **å¹¶è¡Œå¤„ç†**:
   ```python
   # è¾¹ç”Ÿæˆè¾¹æ¨é€,ä¸ç­‰å¾…å®Œæ•´å“åº”
   async for chunk in llm_stream:
       await websocket.send_json(chunk)  # ç«‹å³æ¨é€
   ```

4. **è¿æ¥æ± å¤ç”¨**:
   ```python
   # ä½¿ç”¨å•ä¾‹ HTTP å®¢æˆ·ç«¯
   self._http_client = httpx.AsyncClient(...)  # å¤ç”¨è¿æ¥
   ```

---

## å¿«é€Ÿå¯¼èˆª

### ğŸ“‚ æƒ³è¦æ‰¾åˆ°...

| éœ€æ±‚ | æ–‡ä»¶ä½ç½® |
|------|---------|
| **æ·»åŠ æ–° API ç«¯ç‚¹** | `src/api/routes.py` æˆ–åˆ›å»ºæ–°è·¯ç”±æ–‡ä»¶ |
| **ä¿®æ”¹å¯¹è¯æµç¨‹** | `src/agent/graph.py` + `src/agent/nodes.py` |
| **é…ç½® LLM å‚æ•°** | `src/config/models.py` æˆ– `.env` |
| **ä¿®æ”¹è¯­éŸ³æœåŠ¡** | `src/services/voice/` |
| **æŸ¥çœ‹ API æ–‡æ¡£** | å¯åŠ¨æœåŠ¡åè®¿é—® `/docs` |
| **è°ƒè¯•æ—¥å¿—é…ç½®** | `.env` ä¸­ `VOICE_AGENT_LOG_LEVEL` |
| **æµ‹è¯•ç”¨ä¾‹** | `tests/unit/` æˆ– `tests/integration/` |
| **åŠŸèƒ½è§„æ ¼** | `specs/001-voice-interaction-system/spec.md` |
| **å¼€å‘ä»»åŠ¡** | `specs/001-voice-interaction-system/tasks.md` |
| **å¼€å‘æˆæœ** | `docs/achievements/INDEX.md` |

### ğŸ” å¸¸è§æ“ä½œé€ŸæŸ¥

```bash
# å¯åŠ¨æœåŠ¡
python start_server.py

# è¿è¡Œæµ‹è¯•
pytest

# æŸ¥çœ‹ API æ–‡æ¡£
# http://localhost:8000/docs

# æµ‹è¯•å¯¹è¯
python test_conversation.py

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/voice_agent.log

# ä»£ç æ ¼å¼åŒ–
black src/ tests/

# ç±»å‹æ£€æŸ¥
mypy src/
```

### ğŸ“š ç›¸å…³æ–‡æ¡£é“¾æ¥

- **åŠŸèƒ½è§„æ ¼**: [specs/001-voice-interaction-system/spec.md](./specs/001-voice-interaction-system/spec.md)
- **å®æ–½è®¡åˆ’**: [specs/001-voice-interaction-system/plan.md](./specs/001-voice-interaction-system/plan.md)
- **ä»»åŠ¡åˆ—è¡¨**: [specs/001-voice-interaction-system/tasks.md](./specs/001-voice-interaction-system/tasks.md)
- **å¼€å‘è¿›åº¦**: [specs/001-voice-interaction-system/progress.md](./specs/001-voice-interaction-system/progress.md) (NEW)
- **æ¶æ„æ–‡æ¡£**: [specs/001-voice-interaction-system/architecture.md](./specs/001-voice-interaction-system/architecture.md) (NEW)
- **å¿«é€Ÿå¼€å§‹**: [specs/001-voice-interaction-system/quickstart.md](./specs/001-voice-interaction-system/quickstart.md)
- **å¼€å‘æŒ‡å—**: [DEVELOPMENT.md](./DEVELOPMENT.md) (NEW)
- **æˆæœç´¢å¼•**: [docs/achievements/INDEX.md](./docs/achievements/INDEX.md)
- **å˜æ›´æ—¥å¿—**: [CHANGELOG.md](./CHANGELOG.md) (NEW)

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### ç«‹å³è¡ŒåŠ¨ (æœ¬å‘¨)
- [ ] å®Œæˆ MCP å·¥å…·æ¡†æ¶å®ç°
- [ ] æ·»åŠ åŸºç¡€å·¥å…· (æœç´¢ã€è®¡ç®—å™¨)
- [ ] å®Œå–„å•å…ƒæµ‹è¯•è¦†ç›–ç‡

### çŸ­æœŸç›®æ ‡ (æœ¬æœˆ)
- [ ] å·¥å…·è°ƒç”¨é›†æˆåˆ°å¯¹è¯æµç¨‹
- [ ] æ·»åŠ æ›´å¤š AI å·¥å…· (å›¾åƒç”Ÿæˆã€æ–‡æ¡£åˆ†æ)
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œå‹åŠ›æµ‹è¯•

### é•¿æœŸç›®æ ‡ (ä¸‹å­£åº¦)
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² (Docker + K8s)
- [ ] Redis ä¼šè¯å­˜å‚¨
- [ ] æŒ‡æ ‡ç›‘æ§å’Œå‘Šè­¦
- [ ] å‰ç«¯ç•Œé¢å¼€å‘

---

## ğŸ“ è·å–å¸®åŠ©

- **é¡¹ç›®æ–‡æ¡£**: æŸ¥çœ‹ `docs/` å’Œ `specs/` ç›®å½•
- **API æ–‡æ¡£**: å¯åŠ¨æœåŠ¡åè®¿é—® `/docs`
- **é—®é¢˜æŠ¥å‘Š**: åˆ›å»º GitHub Issue
- **å¼€å‘è®¨è®º**: å›¢é˜Ÿå†…éƒ¨æ²Ÿé€šæ¸ é“

---

## ğŸ‰ Phase 2F é‡ç‚¹åŠŸèƒ½è¯¦è§£

### 1. å®Œæ•´å·¥å…·è°ƒç”¨ç³»ç»Ÿ

**å®ç°äº®ç‚¹**:
- âœ… æ”¯æŒ 7 ä¸ª MCP å·¥å…·ï¼ˆweb_search, calculator, get_time, get_weather, è¯­éŸ³å·¥å…·ï¼‰
- âœ… OpenAI Function Calling æ ‡å‡†æ ¼å¼
- âœ… æµå¼ + éæµå¼åŒæ¨¡å¼æ”¯æŒ
- âœ… æ™ºèƒ½å·¥å…·é€‰æ‹©ï¼ˆLLM è‡ªåŠ¨åˆ¤æ–­ï¼‰
- âœ… é”™è¯¯è‡ªåŠ¨ fallback

**ä½¿ç”¨ç¤ºä¾‹**:
```
ç”¨æˆ·: "æœç´¢ç‰¹æœ—æ™®æœ€æ–°æ–°é—»"
  â†’ LLM æ£€æµ‹åˆ°éœ€è¦æœç´¢å·¥å…·
  â†’ è°ƒç”¨ web_search(query="ç‰¹æœ—æ™® Donald Trump latest news")
  â†’ è¿”å› Tavily æœç´¢ç»“æœ
  â†’ LLM åŸºäºç»“æœç”Ÿæˆç»“æ„åŒ–å›å¤
```

### 2. ä¸Šä¸‹æ–‡è®°å¿†ç³»ç»Ÿ

**æŠ€æœ¯å®ç°**:
- ä½¿ç”¨ `SessionHistoryManager` è¿›è¡Œå†…å­˜å­˜å‚¨
- æ¯ä¸ªä¼šè¯æœ€å¤šä¿ç•™ 20 æ¡æ¶ˆæ¯ï¼ˆå¯é…ç½®ï¼‰
- 24 å°æ—¶ TTL è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯
- ä½¿ç”¨ `deque` é«˜æ•ˆç®¡ç†å†å²é•¿åº¦

**å·¥ä½œæµç¨‹**:
```
API Layer: ä» SessionHistoryManager è·å–å†å²
    â†“
Agent Layer: å°†å†å²æ·»åŠ åˆ° initial_state['external_history']
    â†“
Nodes Layer: _prepare_llm_messages ç»„è£…å†å² + å½“å‰æ¶ˆæ¯
    â†“
LLM API: å¸¦å®Œæ•´ä¸Šä¸‹æ–‡çš„è¯·æ±‚
    â†“
Response: åŸºäºå†å²çš„æ™ºèƒ½å›å¤
    â†“
API Layer: ä¿å­˜æ–°æ¶ˆæ¯åˆ° SessionHistoryManager
```

### 3. æµå¼å“åº” + å·¥å…·è°ƒç”¨é›†æˆ

**åˆ›æ–°å®ç°**:
- æµå¼æ¨¡å¼ä¸‹åŒæ ·æ”¯æŒå·¥å…·è°ƒç”¨
- å®æ—¶æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€ ("ğŸ”§ æ­£åœ¨è°ƒç”¨å·¥å…·: xxx")
- å·¥å…·æ‰§è¡Œåç»§ç»­æµå¼è¾“å‡ºæœ€ç»ˆç­”æ¡ˆ
- æ— ç¼è¡”æ¥ï¼Œç”¨æˆ·ä½“éªŒæµç•…

**æŠ€æœ¯ç»†èŠ‚**:
```python
# æµå¼æ”¶é›†å·¥å…·è°ƒç”¨ä¿¡æ¯
async for chunk in llm_stream:
    if chunk.contains_tool_calls:
        collected_tool_calls.append(chunk)

# æ‰§è¡Œå·¥å…·
results = await execute_tools(collected_tool_calls)

# å¸¦å·¥å…·ç»“æœå†æ¬¡æµå¼è°ƒç”¨ LLM
async for final_chunk in llm_stream_with_results:
    yield final_chunk  # ç»§ç»­æµå¼è¾“å‡º
```

### 4. Markdown æ¸²æŸ“ä¼˜åŒ–

**åŒç«¯å®ç°**:

**åç«¯ï¼ˆç³»ç»Ÿæç¤ºè¯ï¼‰**:
```
è¯·åŠ¡å¿…ä½¿ç”¨ Markdown æ ¼å¼ç»„ç»‡å›å¤ï¼š
- ä½¿ç”¨ ## æ ‡é¢˜åˆ†å±‚
- ç”¨åˆ—è¡¨å‘ˆç°è¦ç‚¹
- ç”¨ **ç²—ä½“** çªå‡ºé‡ç‚¹
- ä»£ç ç”¨ ```è¯­è¨€ ``` åŒ…è£¹
- é“¾æ¥æ ¼å¼ [æ ‡é¢˜](URL)
```

**å‰ç«¯ï¼ˆmarked.js + highlight.jsï¼‰**:
- å®æ—¶ Markdown è§£æ
- ä»£ç è¯­æ³•é«˜äº®
- å“åº”å¼æ ·å¼
- æµå¼æ¸²æŸ“æ”¯æŒ

**æ•ˆæœå¯¹æ¯”**:
```
ä¼˜åŒ–å‰: æ‚ä¹±æ–‡æœ¬ï¼Œéš¾ä»¥é˜…è¯»
ä¼˜åŒ–å: å±‚æ¬¡åˆ†æ˜ï¼Œè§†è§‰ä¼˜ç¾ï¼Œä¿¡æ¯çªå‡º
```

### 5. æ™ºèƒ½æç¤ºè¯ç³»ç»Ÿ

**ä¼˜åŒ–ç­–ç•¥**:
- è¯¦ç»†çš„è§’è‰²å®šä½å’Œèƒ½åŠ›è¯´æ˜
- æ˜ç¡®çš„ä»»åŠ¡å¤„ç†æµç¨‹
- å·¥å…·ä½¿ç”¨æŒ‡å¯¼å’Œæœ€ä½³å®è·µ
- Markdown æ ¼å¼è§„èŒƒ
- ä¿¡æ¯æ¥æºæ ‡æ³¨è¦æ±‚

**å®é™…æ•ˆæœ**:
- AI å›å¤æ›´åŠ ç»“æ„åŒ–
- æœç´¢ç»“æœæ›´æ˜“è¯»
- ä¿¡æ¯æ¥æºæ¸…æ™°
- ä»£ç ç¤ºä¾‹ç¾è§‚

---

## ğŸ”¥ æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹

### 1. æµå¼å·¥å…·è°ƒç”¨æ¶æ„
é¦–æ¬¡å®ç°äº†æµå¼å“åº”æ¨¡å¼ä¸‹çš„å®Œæ•´å·¥å…·è°ƒç”¨æ”¯æŒï¼Œè§£å†³äº†ä¸šç•Œå¸¸è§çš„"æµå¼ vs å·¥å…·è°ƒç”¨"äºŒé€‰ä¸€é—®é¢˜ã€‚

### 2. è½»é‡çº§ä¼šè¯ç®¡ç†
ä½¿ç”¨çº¯å†…å­˜å­˜å‚¨å®ç°é«˜æ€§èƒ½ä¼šè¯å†å²ï¼Œæ— éœ€ Redis ç­‰å¤–éƒ¨ä¾èµ–ï¼Œé™ä½äº†ç³»ç»Ÿå¤æ‚åº¦ã€‚

### 3. åŒç«¯ Markdown ååŒ
åç«¯æç¤ºè¯å¼•å¯¼ + å‰ç«¯å®æ—¶æ¸²æŸ“ï¼Œæ‰“é€ äº†åª²ç¾ ChatGPT çš„è§†è§‰ä½“éªŒã€‚

### 4. æ™ºèƒ½å·¥å…·é€‰æ‹©
LLM æ ¹æ®ç”¨æˆ·æ„å›¾è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦å·¥å…·ï¼Œæ— éœ€æ‰‹åŠ¨è§¦å‘ï¼Œæå‡äº†è‡ªç„¶äº¤äº’ä½“éªŒã€‚

---

## ğŸ“± å¿«é€Ÿä½“éªŒ

```bash
# 1. å¯åŠ¨æœåŠ¡å™¨
python start_server.py

# 2. æµè§ˆå™¨æ‰“å¼€èŠå¤©ç•Œé¢
# æ–¹å¼ä¸€: ç›´æ¥åŒå‡» demo/chat_demo.html
# æ–¹å¼äºŒ: è®¿é—® http://127.0.0.1:8000 (å¦‚å·²é…ç½®é™æ€æ–‡ä»¶æœåŠ¡)

# 3. æµ‹è¯•åœºæ™¯
"æœç´¢ç‰¹æœ—æ™®æœ€æ–°æ–°é—»"     # å·¥å…·è°ƒç”¨
"æˆ‘å«å°æ˜ï¼Œä»Šå¹´25å²"     # ä¸Šä¸‹æ–‡è®°å¿†
"æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿå¤šå¤§ï¼Ÿ"   # éªŒè¯è®°å¿†
"è®¡ç®— 1234 Ã— 5678"      # è®¡ç®—å·¥å…·
"ç°åœ¨å‡ ç‚¹äº†ï¼Ÿ"          # æ—¶é—´å·¥å…·
```

---

*æœ€åæ›´æ–°: 2025-10-17*  
*ç»´æŠ¤è€…: Ivan_HappyWoods Development Team*  
*License: [å¾…å®š]*
