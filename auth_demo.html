<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·è®¤è¯ç³»ç»Ÿ - æµ‹è¯•é¡µé¢</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #374151;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-danger {
            background: #ef4444;
        }

        .result-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .result-box.success {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        .result-box.error {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-badge.logged-in {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.logged-out {
            background: #fee2e2;
            color: #991b1b;
        }

        .user-info {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .user-info p {
            margin: 8px 0;
            font-size: 14px;
            color: #1e40af;
        }

        .user-info strong {
            color: #1e3a8a;
        }

        .settings {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .settings h3 {
            font-size: 16px;
            color: #92400e;
            margin-bottom: 10px;
        }

        .settings input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .token-display {
            background: #1f2937;
            color: #10b981;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            margin-top: 10px;
            word-break: break-all;
            max-height: 150px;
            overflow-y: auto;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        h3 {
            color: #374151;
            font-size: 18px;
            margin: 20px 0 10px 0;
        }

        .divider {
            height: 1px;
            background: #e5e7eb;
            margin: 20px 0;
        }

        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ï¼šæ³¨å†Œå’Œç™»å½• -->
        <div class="card">
            <h2>
                ğŸ” ç”¨æˆ·è®¤è¯æµ‹è¯•
                <span class="status-badge" id="loginStatus">æœªç™»å½•</span>
            </h2>

            <!-- API è®¾ç½® -->
            <div class="settings">
                <h3>âš™ï¸ API é…ç½®</h3>
                <input type="text" id="apiUrl" value="http://127.0.0.1:8000" placeholder="API åœ°å€">
            </div>

            <!-- ç”¨æˆ·æ³¨å†Œ -->
            <h3>ğŸ“ ç”¨æˆ·æ³¨å†Œ</h3>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="regUsername" placeholder="3-50ä¸ªå­—ç¬¦">
            </div>
            <div class="form-group">
                <label>é‚®ç®±</label>
                <input type="email" id="regEmail" placeholder="example@email.com">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="regPassword" placeholder="è‡³å°‘8ä¸ªå­—ç¬¦">
            </div>
            <div class="form-group">
                <label>å…¨åï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="regFullName" placeholder="æ‚¨çš„å§“å">
            </div>
            <button class="btn" onclick="registerUser()">æ³¨å†Œ</button>

            <div class="divider"></div>

            <!-- ç”¨æˆ·ç™»å½• -->
            <h3>ğŸ”‘ ç”¨æˆ·ç™»å½•</h3>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="loginUsername" placeholder="ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="loginPassword" placeholder="å¯†ç ">
            </div>
            <button class="btn" onclick="loginUser()">ç™»å½•</button>

            <!-- ç™»å½•ç»“æœ -->
            <div id="loginResult"></div>
        </div>

        <!-- å³ä¾§ï¼šè®¤è¯æµ‹è¯• -->
        <div class="card">
            <h2>ğŸ§ª API æµ‹è¯•</h2>

            <!-- Token æ˜¾ç¤º -->
            <div id="tokenDisplay"></div>

            <!-- å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
            <h3>ğŸ‘¤ è·å–å½“å‰ç”¨æˆ·</h3>
            <button class="btn btn-secondary" onclick="getCurrentUser()">GET /api/v1/auth/me</button>
            <div id="userInfoResult"></div>

            <div class="divider"></div>

            <!-- Token åˆ·æ–° -->
            <h3>ğŸ”„ åˆ·æ–° Token</h3>
            <button class="btn btn-secondary" onclick="refreshToken()">POST /api/v1/auth/refresh</button>
            <div id="refreshResult"></div>

            <div class="divider"></div>

            <!-- æµ‹è¯•å¯¹è¯æ¥å£ï¼ˆä½¿ç”¨ JWTï¼‰ -->
            <h3>ğŸ’¬ æµ‹è¯•å¯¹è¯æ¥å£ï¼ˆJWT è®¤è¯ï¼‰</h3>
            <div class="form-group">
                <label>æµ‹è¯•æ¶ˆæ¯</label>
                <input type="text" id="testMessage" value="ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯">
            </div>
            <button class="btn btn-secondary" onclick="testChatWithJWT()">å‘é€å¯¹è¯ï¼ˆä½¿ç”¨ JWTï¼‰</button>
            <div id="chatResult"></div>

            <div class="divider"></div>

            <!-- ä¼šè¯ç®¡ç†æµ‹è¯• -->
            <h3>ğŸ“‹ ä¼šè¯ç®¡ç†ï¼ˆSession Managementï¼‰</h3>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="getUserSessions()">è·å–ä¼šè¯åˆ—è¡¨</button>
                <button class="btn btn-secondary" onclick="getSessionDetail()">è·å–ä¼šè¯è¯¦æƒ…</button>
            </div>
            <button class="btn" onclick="startNewSession()" style="margin-top: 10px;">â• æ–°å»ºä¼šè¯</button>
            <div id="sessionResult"></div>

            <div class="divider"></div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons full-width">
                <button class="btn btn-danger" onclick="logout()">æ³¨é”€ç™»å½•</button>
                <button class="btn btn-secondary" onclick="clearAllResults()">æ¸…ç©ºç»“æœ</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨ Token
        let accessToken = localStorage.getItem('access_token') || '';
        let refreshTokenValue = localStorage.getItem('refresh_token') || '';
        let currentUser = null;

        // åˆå§‹åŒ–é¡µé¢
        window.addEventListener('load', () => {
            updateLoginStatus();
            displayTokens();
            
            // å¦‚æœå·²ç™»å½•ï¼Œè‡ªåŠ¨è·å–ç”¨æˆ·ä¿¡æ¯
            if (accessToken) {
                getCurrentUser();
            }
        });

        // æ›´æ–°ç™»å½•çŠ¶æ€
        function updateLoginStatus() {
            const statusBadge = document.getElementById('loginStatus');
            if (accessToken) {
                statusBadge.textContent = 'âœ“ å·²ç™»å½•';
                statusBadge.className = 'status-badge logged-in';
            } else {
                statusBadge.textContent = 'âœ— æœªç™»å½•';
                statusBadge.className = 'status-badge logged-out';
            }
        }

        // æ˜¾ç¤º Token
        function displayTokens() {
            const tokenDisplay = document.getElementById('tokenDisplay');
            if (accessToken) {
                tokenDisplay.innerHTML = `
                    <h3>ğŸ« å½“å‰ Token</h3>
                    <div class="token-display">
                        <strong>Access Token:</strong><br>
                        ${accessToken.substring(0, 50)}...
                        <br><br>
                        <strong>Refresh Token:</strong><br>
                        ${refreshTokenValue.substring(0, 50)}...
                    </div>
                `;
            } else {
                tokenDisplay.innerHTML = '<p style="color: #6b7280; text-align: center; margin-top: 20px;">æš‚æ—  Tokenï¼Œè¯·å…ˆç™»å½•</p>';
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            const resultClass = isError ? 'error' : 'success';
            element.innerHTML = `<div class="result-box ${resultClass}">${JSON.stringify(data, null, 2)}</div>`;
        }

        // è·å– API URL
        function getApiUrl() {
            return document.getElementById('apiUrl').value.trim();
        }

        // ============================================
        // ç”¨æˆ·æ³¨å†Œ
        // ============================================
        async function registerUser() {
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const fullName = document.getElementById('regFullName').value.trim();

            if (!username || !email || !password) {
                alert('è¯·å¡«å†™å¿…å¡«å­—æ®µï¼');
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/api/v1/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        full_name: fullName || null
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('loginResult', {
                        success: true,
                        message: data.message,
                        tip: 'è¯·ä½¿ç”¨æ­¤è´¦å·ç™»å½•'
                    });
                    
                    // è‡ªåŠ¨å¡«å……ç™»å½•è¡¨å•
                    document.getElementById('loginUsername').value = username;
                    document.getElementById('loginPassword').value = password;
                } else {
                    showResult('loginResult', {
                        error: data.detail || 'æ³¨å†Œå¤±è´¥',
                        status: response.status
                    }, true);
                }
            } catch (error) {
                showResult('loginResult', {
                    error: error.message,
                    type: 'NetworkError'
                }, true);
            }
        }

        // ============================================
        // ç”¨æˆ·ç™»å½•
        // ============================================
        async function loginUser() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                alert('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ï¼');
                return;
            }

            try {
                // OAuth2 Password Flow ä½¿ç”¨ application/x-www-form-urlencoded
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                const response = await fetch(`${getApiUrl()}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    // ä¿å­˜ Token
                    accessToken = data.access_token;
                    refreshTokenValue = data.refresh_token;
                    localStorage.setItem('access_token', accessToken);
                    localStorage.setItem('refresh_token', refreshTokenValue);

                    showResult('loginResult', {
                        success: true,
                        message: 'ç™»å½•æˆåŠŸï¼',
                        token_type: data.token_type,
                        expires_in: data.expires_in + ' ç§’',
                        access_token: data.access_token.substring(0, 50) + '...',
                        refresh_token: data.refresh_token.substring(0, 50) + '...'
                    });

                    updateLoginStatus();
                    displayTokens();

                    // è‡ªåŠ¨è·å–ç”¨æˆ·ä¿¡æ¯
                    setTimeout(() => getCurrentUser(), 500);
                } else {
                    showResult('loginResult', {
                        error: data.detail || 'ç™»å½•å¤±è´¥',
                        status: response.status
                    }, true);
                }
            } catch (error) {
                showResult('loginResult', {
                    error: error.message,
                    type: 'NetworkError'
                }, true);
            }
        }

        // ============================================
        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        // ============================================
        async function getCurrentUser() {
            if (!accessToken) {
                showResult('userInfoResult', {
                    error: 'è¯·å…ˆç™»å½•ï¼'
                }, true);
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/api/v1/auth/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    currentUser = data;
                    
                    const userInfoHtml = `
                        <div class="user-info">
                            <p><strong>ç”¨æˆ· ID:</strong> ${data.user_id}</p>
                            <p><strong>ç”¨æˆ·å:</strong> ${data.username}</p>
                            <p><strong>é‚®ç®±:</strong> ${data.email}</p>
                            <p><strong>å…¨å:</strong> ${data.full_name || 'æœªè®¾ç½®'}</p>
                            <p><strong>çŠ¶æ€:</strong> ${data.is_active ? 'âœ… æ¿€æ´»' : 'âŒ ç¦ç”¨'}</p>
                            <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(data.created_at).toLocaleString('zh-CN')}</p>
                        </div>
                    `;
                    document.getElementById('userInfoResult').innerHTML = userInfoHtml;
                } else {
                    if (response.status === 401) {
                        showResult('userInfoResult', {
                            error: 'Token å·²è¿‡æœŸæˆ–æ— æ•ˆ',
                            tip: 'è¯·é‡æ–°ç™»å½•æˆ–åˆ·æ–° Token'
                        }, true);
                    } else {
                        showResult('userInfoResult', {
                            error: data.detail || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥',
                            status: response.status
                        }, true);
                    }
                }
            } catch (error) {
                showResult('userInfoResult', {
                    error: error.message,
                    type: 'NetworkError'
                }, true);
            }
        }

        // ============================================
        // åˆ·æ–° Token
        // ============================================
        async function refreshToken() {
            if (!refreshTokenValue) {
                showResult('refreshResult', {
                    error: 'æ²¡æœ‰å¯ç”¨çš„ Refresh Tokenï¼Œè¯·é‡æ–°ç™»å½•'
                }, true);
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/api/v1/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh_token: refreshTokenValue
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // æ›´æ–° Token
                    accessToken = data.access_token;
                    refreshTokenValue = data.refresh_token;
                    localStorage.setItem('access_token', accessToken);
                    localStorage.setItem('refresh_token', refreshTokenValue);

                    showResult('refreshResult', {
                        success: true,
                        message: 'Token åˆ·æ–°æˆåŠŸï¼',
                        new_access_token: data.access_token.substring(0, 50) + '...',
                        new_refresh_token: data.refresh_token.substring(0, 50) + '...',
                        expires_in: data.expires_in + ' ç§’'
                    });

                    displayTokens();
                } else {
                    showResult('refreshResult', {
                        error: data.detail || 'Token åˆ·æ–°å¤±è´¥',
                        status: response.status
                    }, true);
                }
            } catch (error) {
                showResult('refreshResult', {
                    error: error.message,
                    type: 'NetworkError'
                }, true);
            }
        }

        // ============================================
        // æµ‹è¯•å¯¹è¯æ¥å£ï¼ˆä½¿ç”¨ JWT è®¤è¯ï¼‰
        // ============================================
        async function testChatWithJWT() {
            if (!accessToken) {
                showResult('chatResult', {
                    error: 'è¯·å…ˆç™»å½•è·å– JWT Tokenï¼'
                }, true);
                return;
            }

            const message = document.getElementById('testMessage').value.trim();
            if (!message) {
                alert('è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯ï¼');
                return;
            }

            try {
                // ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„è®¤è¯å¯¹è¯æ¥å£
                const response = await fetch(`${getApiUrl()}/api/v1/conversation/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`  // ä½¿ç”¨ JWT Token
                    },
                    body: JSON.stringify({
                        text: message,  // ä¿®æ”¹å­—æ®µå: message â†’ text
                        output_mode: 'text'  // æ–°å¢å¿…å¡«å­—æ®µ
                        // æ³¨æ„ï¼šä¸æä¾› session_idï¼Œè®©åç«¯è‡ªåŠ¨åˆ›å»ºå¹¶ç»‘å®šç”¨æˆ·
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('chatResult', {
                        success: true,
                        session_id: data.session_id,  // æ˜¾ç¤ºè‡ªåŠ¨åˆ›å»ºçš„ session_id
                        user_input: data.user_input,
                        agent_response: data.agent_response.substring(0, 200) + '...',
                        timestamp: data.timestamp
                    });
                    
                    // ä¿å­˜ session_id ç”¨äºåç»­æŸ¥çœ‹è¯¦æƒ…
                    window.lastSessionId = data.session_id;
                    console.log('Saved session_id from chat:', data.session_id);
                } else {
                    if (response.status === 401) {
                        showResult('chatResult', {
                            error: 'JWT Token æ— æ•ˆæˆ–å·²è¿‡æœŸ',
                            tip: 'è¯·åˆ·æ–° Token æˆ–é‡æ–°ç™»å½•',
                            detail: data.detail
                        }, true);
                    } else {
                        showResult('chatResult', {
                            error: data.detail || 'å¯¹è¯è¯·æ±‚å¤±è´¥',
                            status: response.status
                        }, true);
                    }
                }
            } catch (error) {
                showResult('chatResult', {
                    error: error.message,
                    type: 'NetworkError'
                }, true);
            }
        }

        // ============================================
        // è·å–ç”¨æˆ·ä¼šè¯åˆ—è¡¨
        // ============================================
        async function getUserSessions() {
            if (!accessToken) {
                alert('è¯·å…ˆç™»å½•ï¼');
                showResult('sessionResult', { error: 'æœªç™»å½•' }, true);
                return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/api/v1/conversation/sessions/?page=1&page_size=10`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('sessionResult', {
                        message: 'âœ… è·å–ä¼šè¯åˆ—è¡¨æˆåŠŸ',
                        total: data.total,
                        page: data.page,
                        page_size: data.page_size,
                        has_more: data.has_more,
                        sessions: data.sessions.map(s => ({
                            session_id: s.session_id,
                            status: s.status,
                            message_count: s.message_count,
                            created_at: s.created_at,
                            last_activity: s.last_activity
                        }))
                    });
                    
                    // ä¿å­˜ç¬¬ä¸€ä¸ª session_id ç”¨äºåç»­æµ‹è¯•
                    if (data.sessions && data.sessions.length > 0) {
                        window.lastSessionId = data.sessions[0].session_id;
                        console.log('Saved session_id for detail test:', window.lastSessionId);
                    }
                } else {
                    showResult('sessionResult', {
                        error: 'è·å–ä¼šè¯åˆ—è¡¨å¤±è´¥',
                        status: response.status,
                        detail: data
                    }, true);
                }
            } catch (error) {
                showResult('sessionResult', {
                    error: 'ç½‘ç»œé”™è¯¯',
                    message: error.message,
                    type: 'NetworkError'
                }, true);
            }
        }

        // ============================================
        // è·å–ä¼šè¯è¯¦æƒ…
        // ============================================
        async function getSessionDetail() {
            if (!accessToken) {
                alert('è¯·å…ˆç™»å½•ï¼');
                showResult('sessionResult', { error: 'æœªç™»å½•' }, true);
                return;
            }

            // ä½¿ç”¨ä¸Šæ¬¡ä¿å­˜çš„ session_id æˆ–æç¤ºç”¨æˆ·è¾“å…¥
            let sessionId = window.lastSessionId;
            if (!sessionId) {
                sessionId = prompt('è¯·è¾“å…¥ Session ID (æˆ–å…ˆç‚¹å‡»"è·å–ä¼šè¯åˆ—è¡¨"):');
                if (!sessionId) return;
            }

            try {
                const response = await fetch(`${getApiUrl()}/api/v1/conversation/sessions/${sessionId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('sessionResult', {
                        message: 'âœ… è·å–ä¼šè¯è¯¦æƒ…æˆåŠŸ',
                        session_id: data.session_id,
                        status: data.status,
                        total_messages: data.total_messages,
                        created_at: data.created_at,
                        last_activity: data.last_activity,
                        messages: data.messages.map(m => ({
                            role: m.role,
                            content: m.content.substring(0, 100) + (m.content.length > 100 ? '...' : ''),
                            created_at: m.created_at
                        }))
                    });
                } else {
                    showResult('sessionResult', {
                        error: 'è·å–ä¼šè¯è¯¦æƒ…å¤±è´¥',
                        status: response.status,
                        detail: data
                    }, true);
                }
            } catch (error) {
                showResult('sessionResult', {
                    error: 'ç½‘ç»œé”™è¯¯',
                    message: error.message,
                    type: 'NetworkError'
                }, true);
            }
        }

        // ============================================
        // æ³¨é”€ç™»å½•
        // ============================================
        function logout() {
            if (confirm('ç¡®å®šè¦æ³¨é”€ç™»å½•å—ï¼Ÿ')) {
                accessToken = '';
                refreshTokenValue = '';
                currentUser = null;
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');

                updateLoginStatus();
                displayTokens();
                
                document.getElementById('userInfoResult').innerHTML = '';
                showResult('loginResult', {
                    message: 'å·²æ³¨é”€ç™»å½•'
                });
            }
        }

        // æ¸…ç©ºæ‰€æœ‰ç»“æœ
        function clearAllResults() {
            document.getElementById('loginResult').innerHTML = '';
            document.getElementById('userInfoResult').innerHTML = '';
            document.getElementById('refreshResult').innerHTML = '';
            document.getElementById('chatResult').innerHTML = '';
            document.getElementById('sessionResult').innerHTML = '';
        }

        // ============================================
        // æ–°å»ºä¼šè¯
        // ============================================
        async function startNewSession() {
            if (!accessToken) {
                alert('è¯·å…ˆç™»å½•ï¼');
                showResult('sessionResult', { error: 'æœªç™»å½•' }, true);
                return;
            }

            try {
                // è°ƒç”¨æ–°å»ºä¼šè¯æ¥å£
                const response = await fetch('/api/v1/conversation/sessions/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: `å¯¹è¯ ${new Date().toLocaleString('zh-CN')}`
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // ä¿å­˜æ–°ä¼šè¯ ID
                    window.lastSessionId = result.session_id;
                    
                    // æ¸…ç©ºå¯¹è¯ç»“æœåŒºåŸŸ
                    document.getElementById('chatResult').innerHTML = '';
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showResult('sessionResult', {
                        success: true,
                        message: result.message,
                        session_id: result.session_id,
                        title: result.title,
                        created_at: result.created_at
                    });
                    
                    // æ»šåŠ¨åˆ°å¯¹è¯è¾“å…¥æ¡† (æ— åŠ¨ç”»)
                    const chatSection = document.querySelector('h3:nth-of-type(3)'); // "æµ‹è¯•å¯¹è¯æ¥å£" æ ‡é¢˜
                    if (chatSection) {
                        chatSection.scrollIntoView({ behavior: 'auto', block: 'start' });
                    }
                } else {
                    showResult('sessionResult', { error: result.message || 'åˆ›å»ºä¼šè¯å¤±è´¥' }, true);
                }
            } catch (error) {
                console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
                showResult('sessionResult', { error: `åˆ›å»ºä¼šè¯å¤±è´¥: ${error.message}` }, true);
            }
        }
    </script>
</body>
</html>
